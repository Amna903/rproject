library(tibble)

# Load data and convert to tibble
load("data_risk.RData")
data_risk <- as_tibble(data_risk)

# Inspect structure
glimpse(data_risk)
summary(data_risk)
library(tidyverse)

data_2024 <- data_risk %>%
  filter(year == 2024)
ggplot(data_2024, aes(x = lt_fc_rating, y = gdp_pc)) +
  geom_boxplot() +
  labs(
    title = "GDP per Capita vs LT FC Rating (2024)",
    x = "Long-Term FC Rating",
    y = "GDP per Capita (USD)"
  ) +
  theme_minimal()
ggplot(data_2024, aes(x = lt_fc_rating, y = cpi_gr)) +
  geom_boxplot() +
  labs(
    title = "CPI Growth vs LT FC Rating (2024)",
    x = "Long-Term FC Rating",
    y = "CPI Growth (%)"
  ) +
  theme_minimal()
ggplot(data_2024, aes(x = lt_fc_rating, y = unemp_rate)) +
  geom_boxplot() +
  labs(
    title = "Unemployment Rate vs LT FC Rating (2024)",
    x = "Long-Term FC Rating",
    y = "Unemployment Rate (%)"
  ) +
  theme_minimal()
ggplot(data_2024, aes(x = lt_fc_rating, y = gg_bal_gdp)) +
  geom_boxplot() +
  labs(
    title = "Government Balance (% of GDP) vs LT FC Rating (2024)",
    x = "Long-Term FC Rating",
    y = "Government Balance (% of GDP)"
  ) +
  theme_minimal()
  
  
  ggplot(data_2024, aes(x = debt_rev, y = gdp_pc, color = lt_fc_rating)) +
  geom_point() +
  labs(
    title = "Debt/Revenues vs GDP per Capita (2024)",
    x = "Debt / Revenues (%)",
    y = "GDP per Capita (USD)",
    color = "Rating"
  ) +
  theme_minimal()


ggplot(data_2024, aes(x = unemp_rate, y = cpi_gr, color = lt_fc_rating)) +
  geom_point() +
  labs(
    title = "Unemployment vs CPI Growth (2024)",
    x = "Unemployment Rate (%)",
    y = "CPI Growth (%)",
    color = "Rating"
  ) +
  theme_minimal()
median_trends <- data_risk %>%
  group_by(year, lt_fc_rating) %>%
  summarize(
    median_gdp_pc = median(gdp_pc, na.rm = TRUE),
    median_cpi_gr = median(cpi_gr, na.rm = TRUE)
  )

# Plot median GDP per capita over time
ggplot(median_trends, aes(x = year, y = median_gdp_pc, color = lt_fc_rating)) +
  geom_line() +
  labs(
    title = "Median GDP per Capita Over Time by Rating",
    x = "Year",
    y = "Median GDP per Capita (USD)",
    color = "Rating"
  ) +
  theme_minimal()
ggplot(median_trends, aes(x = year, y = median_cpi_gr, color = lt_fc_rating)) +
  geom_line() +
  labs(
    title = "Median CPI Growth Over Time by Rating",
    x = "Year",
    y = "Median CPI Growth (%)",
    color = "Rating"
  ) +
  theme_minimal()
# Select numeric variables for correlation
correlation_trends <- data_risk %>%
  group_by(year) %>%
  summarize(
    corr_rating_gdp_pc = cor(as.numeric(lt_fc_rating), gdp_pc, use = "complete.obs"),
    corr_rating_cpi_gr = cor(as.numeric(lt_fc_rating), cpi_gr, use = "complete.obs"),
    corr_rating_unemp = cor(as.numeric(lt_fc_rating), unemp_rate, use = "complete.obs")
  )

# Check results
head(correlation_trends)

# Plot correlations over time
ggplot(correlation_trends, aes(x = year)) +
  geom_line(aes(y = corr_rating_gdp_pc, color = "GDP per Capita")) +
  geom_line(aes(y = corr_rating_cpi_gr, color = "CPI Growth")) +
  geom_line(aes(y = corr_rating_unemp, color = "Unemployment Rate")) +
  labs(
    title = "Correlation Between LT FC Rating and Macroeconomic Variables Over Time",
    x = "Year",
    y = "Correlation Coefficient",
    color = "Variable"
  ) +
  theme_minimal()

library(tidyverse)
library(quantmod)
library(zoo)

# Symbols

symbols <- c("AAPL", "TSLA", "NVDA", "XLF", "^GSPC", "^N225", "BZ=F", "GC=F", "TNX", "BTC-USD")

# Download and merge Close prices, interpolate internal missing values

prices <- map(symbols, ~ Cl(getSymbols(.x, src = "yahoo", from = "2010-01-01", to = Sys.Date(), auto.assign = FALSE))) %>%
reduce(merge)

# Convert to data.frame and add date column

prices_df <- data.frame(date = index(prices), coredata(prices))

# Rename columns to valid names

colnames(prices_df) <- c("date", "AAPL", "TSLA", "NVDA", "XLF", "GSPC", "N225", "Brent", "Gold", "TNX", "BTC")

# Interpolate internal NAs only

prices_df <- prices_df %>%
mutate(across(AAPL:BTC, ~ na.approx(., na.rm = FALSE))) %>%
mutate(TNX = TNX / 10)  # convert TNX to percentage

# --- Plot Equities ---

prices_df %>%
select(date, AAPL, TSLA, NVDA, XLF) %>%
pivot_longer(-date, names_to = "Ticker", values_to = "Price") %>%
filter(!is.na(Price)) %>%
ggplot(aes(x = date, y = Price, color = Ticker)) +
geom_line() +
labs(title = "Equity Price Levels (2010–2025)", x = "Date", y = "Price", color = "Ticker") +
theme_minimal()

# --- Plot Indices ---

prices_df %>%
select(date, GSPC, N225) %>%
pivot_longer(-date, names_to = "Index", values_to = "Price") %>%
filter(!is.na(Price)) %>%
ggplot(aes(x = date, y = Price, color = Index)) +
geom_line() +
labs(title = "Index Levels (2010–2025)", x = "Date", y = "Price", color = "Index") +
theme_minimal()

# --- Plot Commodities ---

prices_df %>%
select(date, Brent, Gold) %>%
pivot_longer(-date, names_to = "Commodity", values_to = "Price") %>%
filter(!is.na(Price)) %>%
ggplot(aes(x = date, y = Price, color = Commodity)) +
geom_line() +
labs(title = "Commodity Levels (2010–2025)", x = "Date", y = "Price", color = "Commodity") +
theme_minimal()

# --- Plot U.S. 10-Year Yield ---

prices_df %>%
filter(!is.na(TNX)) %>%
ggplot(aes(x = date, y = TNX)) +
geom_line(color = "blue") +
labs(title = "U.S. 10-Year Yield (2010–2025)", x = "Date", y = "Yield (%)") +
theme_minimal()

# --- Plot Bitcoin ---

prices_df %>%
filter(!is.na(BTC)) %>%
ggplot(aes(x = date, y = BTC)) +
geom_line(color = "orange") +
labs(title = "Bitcoin Price (2010–2025)", x = "Date", y = "Price (USD)") +
theme_minimal()

# Normalize each series to 100 at first non-NA observation
prices_norm <- prices_df %>%
  mutate(across(AAPL:BTC, ~ . / first(.[!is.na(.)]) * 100))

# Pivot longer for plotting
prices_norm_long <- prices_norm %>%
  pivot_longer(-date, names_to = "Asset", values_to = "IndexValue")

# Plot all normalized series
ggplot(prices_norm_long, aes(x = date, y = IndexValue, color = Asset)) +
  geom_line() +
  labs(
    title = "Normalized Asset Levels (Base=100 at first observation)",
    x = "Date",
    y = "Index (Base 100)",
    color = "Asset"
  ) +
  theme_minimal()
library(lubridate)

# Every 6 months starting from first date
index_6mo <- prices_norm %>%
  filter(day(date) == 1 & month(date) %% 6 == 1) %>%  # approx. every 6 months
  select(date, AAPL:BTC)

# Round values to 2 decimals
index_6mo <- index_6mo %>% mutate(across(AAPL:BTC, ~ round(., 2)))

# Show table
index_6mo

